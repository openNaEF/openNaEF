/** 
 * @projectDescription	A simpe HTMLTable editor.
 *
 * @author 	mizuki fujitani (makinosuke) f-mzk@m78.com
 * @version 1.0 2009-08-18
 * @license GPL
 */

(function($){var TEDIT_NS='tedit@m12i.com';var tedit=function(spec,element){var that={},matrix=[],clipboard=[],basic_data={content:'',colspan:1,rowspan:1},ui=(element||$('<div></div>')).addClass('ui-widget ui-widget-content ui-corner-all tedit-ui'),defaults={rows:2,minRow:2,maxRow:0,cols:2,minCol:2,maxCol:0,cellHeight:60,cellWidth:80,gridHeight:300,gridWidth:600,thead:0,tfoot:0,toolbar:true,lang_thead:'ヘッダ行数',lang_tfoot:'フッタ行数',lang_edit:'編集',lang_new:'追加',lang_del:'削除',lang_copy:'コピー',lang_cut:'切り取り',lang_paste:'貼り付け',lang_join:'結合',lang_split:'分割',dblclick:false,pressEdit:false,selected:false,unselected:false,sorted:false};spec=$.extend({},defaults,spec);ui=ui.html('<div class="ui-helper-clearfix tedit-ui-toolbar-top"'+(spec.toolbar?'':' style="display: none;"')+'></div>'+'<div class="ui-helper-clearfix tedit-ui-grid">'+'<div class="ui-icon ui-icon-arrow-4-diag tedit-ui-gcorner"></div>'+'<div class="ui-widget-content ui-corner-top tedit-ui-cgrips"><ol></ol></div>'+'<div class="ui-widget-content ui-corner-left tedit-ui-rgrips"><ol></ol></div>'+'<div class="ui-widget-content ui-corner-br tedit-ui-cells">'+'<table class="ui-widget-content"><tbody></tbody></table>'+'</div>'+'</div>'+'<div class="ui-helper-clearfix tedit-ui-toolbar-bottom"'+(spec.toolbar?'':' style="display: none;"')+'></div>');var bar1=$('>div:first',ui),bar2=bar1.next().next(),gcorner=$('>div:first',bar1.next()).draggable({helper:'clone',delay:250,stop:function(){return false;},drag:function(event,ui){grid.scrollTop(ui.position.top*2);grid.scrollLeft(ui.position.left*2);}}),cgrips=gcorner.next().css({width:spec.gridWidth}),cg_ol=cgrips.children('ol'),rgrips=cgrips.next().css({height:spec.gridHeight}),rg_ol=rgrips.children('ol'),grid_size_fix=function(){grid.css({height:spec.gridHeight,width:spec.gridWidth});var h=(spec.cellHeight+2)*spec.rows,w=(spec.cellWidth+2)*spec.cols;table.css({height:h,width:w});cg_ol.css('width',w);rg_ol.css('height',h);$('> span:eq(0)',cg_ol.children('li')).css({marginLeft:(spec.cellWidth-(16*3))/($.browser.msie?4:2)});$('> span:eq(0)',rg_ol.children('li')).css({marginTop:(spec.cellHeight-(16*3))/($.browser.msie?4:2)});},grid=rgrips.next().scroll(function(event){var g=$(this);cg_ol.css('left',0-g.scrollLeft());rg_ol.css('top',0-g.scrollTop());}),selected,table=grid.children('table'),tbody=table.children('tbody').selectable({filter:'>tr>td',start:function(event,ui){selection_cancel();},stop:function(event,ui){selection_update();}}),selection_cancel=function(){if($.browser.msie){$('> tr > td.ui-selected',tbody).removeClass('ui-selected').children('div').removeClass('ui-state-focus');}else{if(selected)selected.removeClass('ui-selected').children('div').removeClass('ui-state-focus');}},selection_update=function(){selected=$('> tr > td.ui-selected',tbody);selected.children('div').addClass('ui-state-focus');selection_type=selected.length===1?'point':'rect';};$('ol>li',grid).live('mouseover',function(){$(this).addClass('ui-state-hover');}).live('mouseout',function(){$(this).removeClass('ui-state-hover');});$('div.tedit-ui-rgrips > ol > li > span',ui).live('click',function(){selection_cancel();var row=this.parentNode.title-0;if(/tedit-ui-grip-button-(prev|next|sel)/.test(this.className)){switch(RegExp.$1){case'prev':if(row>0){method_move('y',row,row-1);thead_markup();}break;case'next':if(row<spec.rows){method_move('y',row,row+1);thead_markup();}break;case'sel':$('>tr:eq('+row+')>td',tbody).addClass('ui-selected');selection_update();selection_type='row';break;}}});$('div.tedit-ui-cgrips > ol > li > span',ui).live('click',function(){selection_cancel();var col=this.parentNode.title-0;if(/tedit-ui-grip-button-(prev|next|sel)/.test(this.className)){switch(RegExp.$1){case'prev':if(col>0){method_move('x',col,col-1);}break;case'next':if(col<spec.cols){method_move('x',col,col+1);}break;case'sel':tbody.children('tr').each(function(index){if(typeof matrix[index][col]==='number'){$(this).children('td:eq('+matrix[index][col]+')').addClass('ui-selected');}});selection_update();selection_type='col';break;}}});var cg='<li class="ui-widget-content">'+'<span class="ui-icon ui-icon-arrow-1-w tedit-ui-grip-button-prev"></span>'+'<span class="ui-icon ui-icon-bullet tedit-ui-grip-button-sel"></span>'+'<span class="ui-icon ui-icon-arrow-1-e tedit-ui-grip-button-next"></span>'+'</li>',rg='<li class="ui-widget-content">'+'<span class="ui-icon ui-icon-arrow-1-n tedit-ui-grip-button-prev"></span>'+'<span class="ui-icon ui-icon-bullet tedit-ui-grip-button-sel"></span>'+'<span class="ui-icon ui-icon-arrow-1-s tedit-ui-grip-button-next"></span>'+'</li>',cg_fix=function(){var li=cg_ol.children('li'),diff,base=li.length,i;if(li.length>spec.cols){li.filter(':gt('+(spec.cols-1)+')').remove();}else if(li.length<spec.cols){diff=spec.cols-base;for(i=0;i<diff;i++){li=$(cg).attr('title',base+i).css('width',spec.cellWidth);cg_ol.append(li);}}},rg_fix=function(){var li=rg_ol.children('li'),diff,base,i;if(li.length>spec.rows){li.filter(':gt('+(spec.rows-1)+')').remove();}else if(li.length<spec.rows){base=li.length;diff=spec.rows-base;for(i=0;i<diff;i++){rg_ol.append($(rg).attr('title',base+i).css('height',spec.cellHeight));}}};cg_fix();rg_fix();grid_size_fix();var selection_type;var create_cell=function(data,asString){data=$.extend({},basic_data,data||{});var td='<td class="ui-widget-content ui-selectee" style="height: '+spec.cellHeight+'px; width: '+(spec.cellWidth)+'px;"><div class="ui-widget-content">'+('content'in data?data.content:'')+'</div></td>';return asString?td:$(td);};var create_row=function(cols,asString){var row='<tr>',i,cell=create_cell({},true);for(i=0;i<cols;i++){row+=cell;}row+='</tr>';return asString?row:$(row);},matrix_indexes_update=function(){var i,j,index;for(i=0;i<spec.rows;i++){index=0;for(j=0;j<spec.cols;j++){if(typeof matrix[i][j]==='number'){matrix[i][j]=index;index++;}}}},matrix_update=function(){var x=0,y=0,i,j,tr,colspan,rowspan;for(i=0;i<spec.rows;i++){matrix[i]=[];for(j=0;j<spec.cols;j++){matrix[i][j]=1;}}matrix.length=spec.rows;tbody.children('tr').each(function(tr_index){tr=$(this);if(y===spec.rows){tr.remove().prevAll('tr').remove();return false;}x=0;tr.children('td').each(function(td_index){while(typeof matrix[y][x]!=='number'&&x<spec.cols){x++;}td=$(this);colspan=td.attr('colspan')-0||1;rowspan=td.attr('rowspan')-0||1;if(colspan>1){for(i=1;i<colspan;i++){matrix[y][x+i]={origin:[x,y],delta:[i,0],span:[colspan,rowspan]};}}if(rowspan>1){for(i=1;i<rowspan;i++){for(j=0;j<colspan;j++){matrix[y+i][x+j]={origin:[x,y],delta:[j,i],span:[colspan,rowspan]};}}}x++;});y++;});matrix_indexes_update();selects_update();selects_adj();},coord=function(td){var td=$(td),y=td.parent().prevAll('tr').length,prev_td=td.prevAll('td').length,x=0;while(matrix[y][x]!==prev_td&&x<spec.cols){x++;}return[x,y];},find=function(coord){var x=coord[0],y=coord[1];return x>=spec.cols||y>=spec.rows?undefined:typeof matrix[y][x]!=='number'?null:$('>tr:eq('+y+')',tbody).children(':eq('+matrix[y][x]+')');},val=function(td,data){if(data){data=$.extend({},basic_data,data);if((data.colspan&&data.colspan>1)||(data.rowspan&&data.rowspan>1)){method_join(td,[data.colspan||1,data.rowspan||1]);}$.data(td.get(0),TEDIT_NS,data);td.children('div').html(data.content||' ');}else{data=$.extend({},basic_data,$.data(td.get(0),TEDIT_NS));data.colspan=td.attr('colspan')&&td.attr('colspan')>1?td.attr('colspan'):undefined;data.rowspan=td.attr('rowspan')&&td.attr('rowspan')>1?td.attr('rowspan'):undefined;}return data;},selection_coords=function(){if(selected&&selected.length){var origin=coord(selected.eq(0)),delta=coord(selected.eq(selected.length-1));delta[0]=delta[0]-origin[0];delta[1]=delta[1]-origin[1];return{origin:origin,delta:delta};}else{false;}};var selects_update=function(){var i,j,options;if(!thead_select){thead_select=$('select:eq(0)',bar2).change(function(){spec.thead=this.value;selects_adj();});tfoot_select=$('select:eq(1)',bar2).change(function(){spec.tfoot=this.value;selects_adj();});}options=thead_select.children('option');for(i=0;i<spec.rows-options.length;i++){thead_select.append('<option value="'+(options.length+i)+'"> '+(options.length+i)+' </option>');}for(i=0;i<options.length-spec.rows;i++){options.eq(options.length-1).remove();;}options=tfoot_select.children('option');for(i=0;i<spec.rows-options.length;i++){tfoot_select.append('<option value="'+(options.length+i)+'"> '+(options.length+i)+' </option>');}for(i=0;i<options.length-spec.rows;i++){options.eq(options.length-1).remove();;}},selects_adj=function(){var thead_rows=spec.thead,i,y,trs;y=thead_rows<spec.rows?thead_rows:spec.rows-1;thead_loop:while(y<spec.rows&&y>0){for(i=0;i<spec.cols;i++){if(typeof matrix[y][i]!=='number'&&matrix[y][i].delta[1]>0){y=matrix[y][i].origin[1];continue thead_loop;}}break;}spec.thead=y;thead_select.val(spec.thead);var tfoot_rows=spec.tfoot;tfoot_rows=tfoot_rows<spec.rows-spec.thead?tfoot_rows:spec.rows-spec.thead-1;y=spec.rows-tfoot_rows;tfoot_loop:while(y<spec.rows&&y>0){for(i=0;i<spec.cols;i++){if(typeof matrix[y][i]!=='number'&&matrix[y][i].delta[1]>0){y=matrix[y][i].origin[1]+matrix[y][i].span[1];continue tfoot_loop;}}break;}spec.tfoot=spec.rows-y;tfoot_select.val(spec.tfoot);thead_markup();},thead_markup=function(){$('> tr',tbody).removeClass('tedit-ui-grid-thead tedit-ui-grid-tfoot');$('tr:lt('+spec.thead+')',tbody).addClass('tedit-ui-grid-thead');$('tr:gt('+(spec.rows-spec.tfoot-1)+')',tbody).addClass('tedit-ui-grid-tfoot');},thead_select,tfoot_select;if(spec.toolbar){var btn_icons={edit:'ui-icon-pencil','new':'ui-icon-plus',del:'ui-icon-trash',copy:'ui-icon-copy',cut:'ui-icon-scissors',paste:'ui-icon-clipboard','join':'','split':''},btn_src='';for(i in btn_icons){btn_src+='<button class="ui-corner-all ui-state-default tedit-ui-tb1-button-'+i+'">'+'<span class="ui-icon '+(btn_icons[i]||'ui-icon-wrench')+'"></span><span>'+spec['lang_'+i]+'</span>'+'</button>';}bar1.append(btn_src);bar1.children('button').click(function(event){var index,point,xy,coords;if(/tedit-ui-tb1-button-(\w+)/.test(this.className)){switch(RegExp.$1){case'edit':if(selection_type!=='point'){point=selected.eq(0);selection_cancel();point.addClass('ui-selected');selection_update();}else{point=selected;}if(spec.pressEdit){spec.pressEdit.call(point.get(0),event,{object:that,jquery:ui,xy:coord(point)});}break;case'new':if(selection_type==='col'){index=coord(selected.eq(0))[0];method_insert('x',index);}else if(selection_type==='row'){index=coord(selected.eq(0))[1];method_insert('y',index);}else{selection_cancel();method_insert('x',-1);method_scroll([spec.cols*spec.cellWidth,0])}break;case'del':if(selection_type==='col'){method_delete('x',coord(selected.eq(0))[0]);}else if(selection_type==='row'){method_delete('y',coord(selected.eq(0))[1]);}break;case'copy':if(coords=selection_coords()){method_copy(coords.origin,coords.delta);}break;case'cut':if(coords=selection_coords()){method_cut(coords.origin,coords.delta);}break;case'paste':if(coords=selection_coords()){method_paste(coords.origin,coords.delta);}break;case'join':if(selection_type!=='point'&&(coords=selection_coords())){method_join(coords.origin,coords.delta);}break;case'split':if(selection_type==='point'){method_split(selected.eq(0));}else if(selected.length){selected.each(function(){var cell=$(this).filter('td[colspan][colspan!=1],td[rowspan][rowspan!=1]');if(cell.length){method_split(cell);}});selection_cancel();}break;}}}).mousedown(function(){$(this).addClass('ui-state-active');}).mouseup(function(){$(this).removeClass('ui-state-active');});if($.browser.msie){bar1.children('button').each(function(){var btn=$(this),width=0;btn.children('span').each(function(){width+=$(this).outerWidth();});btn.width(width+16);});}var tb2_icons={thead:'ui-icon-wrench',tfoot:'ui-icon-wrench'},select_src='';for(i in tb2_icons){select_src+='<div class=""><span class="ui-icon '+(tb2_icons[i]||'ui-icon-wrench')+'"></span><label>'+spec['lang_'+i]+'<select class="ui-state-default tedit-ui-tb2-select"><option value="0"> 0 </option></select></label></div>';}bar2.append(select_src);bar2.children('button').click(function(event){});}var i,j,tr;for(i=0;i<spec.rows;i++){tbody.append(create_row(spec.cols));}matrix_update();tbody.dblclick(function(event){if(spec.dblclick){spec.dblclick.call(selected.get(0),event,{object:that,jquery:ui,xy:coord(selected)});}});var method_copy=function(origin,delta){var i,j,tr,td,orig_x=origin[0],orig_y=origin[1],delta_x=delta[0],delta_y=delta[1];if(typeof matrix[orig_y][orig_x]!=='number'){return that;}clipboard=[];for(i=0;i<=delta_y;i++){tr=$('> tr:eq('+(orig_y+i)+')',tbody);clipboard[i]=[];for(j=0;j<=delta_x;j++){if(typeof matrix[orig_y+i][orig_x+j]==='number'){td=find([orig_x+j,orig_y+i]);clipboard[i][j]=val(td);}else{clipboard[i][j]=null;}}}return that;},method_cut=function(origin,delta){var i,j,tr,td,orig_x=origin[0],orig_y=origin[1],delta_x=delta[0],delta_y=delta[1];if(typeof matrix[orig_y][orig_x]!=='number'){return that;}clipboard=[];for(i=0;i<=delta_y;i++){tr=$('> tr:eq('+(orig_y+i)+')',tbody);clipboard[i]=[];for(j=0;j<=delta_x;j++){if(typeof matrix[orig_y+i][orig_x+j]==='number'){td=find([orig_x+j,orig_y+i]);clipboard[i][j]=val(td);$.removeData(td.get(0),TEDIT_NS);td.children('div').html(' ');}else{clipboard[i][j]=null;}}}return that;},method_paste=function(origin,delta){var i,j,tr,td,orig_x=origin[0],orig_y=origin[1],delta_x=delta[0],delta_y=delta[1];delta_x=spec.cols-orig_x>delta_x?delta_x:spec.cols-orig_x;delta_y=spec.rows-orig_y>delta_y?delta_y:spec.rows-orig_y;if(typeof matrix[orig_y][orig_x]!=='number'){return that;}if(clipboard.length===1&&clipboard[0].length===1){for(i=0;i<=delta_y;i++){for(j=0;j<=delta_x;j++){var td=find([orig_x+j,orig_y+i]);if(td&&td.length&&clipboard[0][0]){val(td,clipboard[0][0]);}}}}else{for(i=0;i<=delta_y;i++){for(j=0;j<=delta_x;j++){if(!clipboard[i]||!clipboard[i][j]||clipboard[i][j]===null){continue;}var td=find([orig_x+j,orig_y+i]);if(td&&td.length&&clipboard[i]&&clipboard[i][j]){val(td,clipboard[i][j]);}}}}return that;},method_move=function(axis,from,to){if(arguments.length>=3||typeof from==='number'||typeof to==='number'||from<0||axis==='x'?(from<spec.cols&&to<spec.cols):(from<spec.rows&&to<spec.rows)){if(axis==='x'){to=to<0?spec.cols-1:to;if(from===to){return that;}tbody.children('tr').each(function(){var td=$(this).children('td:eq('+from+')');if(to<from){$(this).children('td:eq('+to+')').before(td);}else{$(this).children('td:eq('+to+')').after(td);}});}else{to=to<0?spec.rows-1:to;if(from===to){return that;}tbody.children('tr:eq('+from+'),tr:eq('+to+')').children('td[colspan][colspan!=1],td[rowspan][rowspan!=1]').each(function(){method_split(this);});for(var i=0;i<spec.cols;i++){if(typeof matrix[from][i]!=='number'){method_split(matrix[from][i].origin);}if(typeof matrix[to][i]!=='number'){method_split(matrix[to][i].origin);}}if(to<from){tbody.children('tr:eq('+to+')').before(tbody.children('tr:eq('+from+')'));}else{tbody.children('tr:eq('+to+')').after(tbody.children('tr:eq('+from+')'));}}matrix_update();}return that;},method_join=function(origin,delta){var td;if(!$.isArray(origin)){td=$(origin);origin=coord(origin);if(typeof matrix[origin[0],origin[1]]==='number'){return that;}delta=[delta[0]-1,delta[1]-1];}var x=origin[0],y=origin[1],delta_x=delta[0],delta_y=delta[1],coords=[],i,j;if((delta_x===0&&delta_y===0)||(delta_x<0||delta_y<0)){return that;}if(delta_y>=0&&delta_x>=0){for(i=0;i<=delta_y;i++){for(j=0;j<=delta_x;j++){if(typeof matrix[y+i][x+j]==='number'){coords.push([x+j,y+i]);}else{return that;}}}}if(!td){td=find(coords[0]);}for(i=1;i<coords.length;i++){coords[i]=find(coords[i]);if(coords[i].attr('colspan')&&coords[i].attr('colspan')>1||coords[i].attr('rowspan')&&coords[i].attr('rowspan')>1){return that;}}for(i=1;i<coords.length;i++){coords[i].remove();}td.attr({colspan:delta_x+1,rowspan:delta_y+1}).css({height:((spec.cellHeight)*(delta_y+1)),width:((spec.cellWidth+1)*(delta_x+1))-1});if($.browser.msie){selection_cancel();tbody.html(tbody.html());}matrix_update();return that;},method_split=function(target){var origin=$.isArray(target)?target:coord(target),td=$.isArray(target)?find(target):$(target),colspan,rowspan,i,cell,cells='';if(!td||!td.length){return that;}colspan=td.attr('colspan')||1;rowspan=td.attr('rowspan')||1;cell=create_cell({},true);if(colspan>1){for(i=1;i<colspan;i++){cells+=cell;}td.after(cells);}if(rowspan>1){cells+=cell;var tr=td.parent();for(i=1;i<rowspan;i++){var x=origin[0],y=i+origin[1];tr=tr.next('tr');while(x>=0&&typeof matrix[y][x]!=='number'){x--;}if(x===-1){tr.prepend(cells);}else{tr.children('td').eq(matrix[y][x]).after(cells);}}}td.css({height:spec.cellHeight,width:spec.cellWidth}).attr('colspan',1).attr('rowspan',1);if($.browser.msie){td.attr('colSpan',1);td.attr('rowSpan',1);selection_cancel();tbody.html(tbody.html());}matrix_update();return that;};var method_show=function(speed,callback){if(typeof speed==='string'||typeof speed==='number'){ui.show(speed,$.isFunction(callback)?function(){callback.call(that);}:undefined);}else{ui.show();}return that;};var method_hide=function(speed,callback){if(typeof speed==='string'||typeof speed==='number'){ui.hide(speed,$.isFunction(callback)?function(){callback.call(that);}:undefined);}else{ui.hide();}return that;};var method_val=function(xy,data){var td,col=xy[0],row=xy[1];if(arguments.length===1){if(col<spec.cols&&row<spec.rows){td=find([col,row]);if(td&&td.length){return val(td);}}return undefined;}else if(arguments.length==2){if(col<spec.cols&&row<spec.rows){td=find([col,row]);if(td&&td.length){val(td,data);}}return that;}},method_matrix=function(dataOrOption){var i,j,dataMatrix;if(dataOrOption&&$.isArray(dataOrOption)){if(dataOrOption.length&&$.isArray(dataOrOption[0])){dataMatrix=dataOrOption;for(i=0;i<spec.rows;i++){for(j=0;j<spec.cols;j++){if(typeof matrix[i][j]==='number'&&dataMatrix[i]&&dataMatrix[i][matrix[i][j]]){val(find([j,i]),dataMatrix[i][matrix[i][j]]);}}}}return that;}else{dataMatrix=[];for(i=0;i<spec.rows;i++){dataMatrix[i]=[];for(j=0;j<spec.cols;j++){if(typeof matrix[i][j]==='number'){if(dataOrOption===true){dataMatrix[i][j]=val(find([j,i]));}else{dataMatrix[i].push(val(find([j,i])));}}else if(dataOrOption===true){dataMatrix[i][j]=null;}}}return dataMatrix;}};var method_jquery=function(){return ui;};var method_scroll=function(xy){grid.scrollTop(xy[1]);grid.scrollLeft(xy[0]);return that;};var method_insert=function(axis,index){index=typeof index==='number'?index:0;if((axis==='x'&&spec.maxCol>0&&spec.cols===spec.maxCol)||(axis!=='x'&&spec.maxRow>0&&spec.rows===spec.maxRow)){return that;}if(axis==='x'){if(index<0){tbody.children('tr').each(function(){$(this).append(create_cell());});}else if(index===0){tbody.children('tr').each(function(){$(this).prepend(create_cell());});}else{tbody.children('tr').each(function(){var td=$('>td:eq('+index+')',this),cell=create_cell();if(td.length){td.before(cell);}else{$(this).append(cell);}});}spec.cols++;cg_fix();}else{if(index<0){tbody.append(create_row(spec.cols,true));}else if(index===0){tbody.prepend(create_row(spec.cols,true));}else{var diff=0;for(i=0;i<spec.rows;i++){if(typeof matrix[index][i]!=='number'&&matrix[index][i].delta[1]>0){method_split(matrix[index][i].origin);}}tbody.children('tr:eq('+index+')').before(create_row(spec.cols,true));}spec.rows++;rg_fix();}grid_size_fix();matrix_update();};var method_delete=function(axis,index){if((axis==='x'?spec.cols>spec.minCol:spec.rows>spec.minRow)&&typeof index==='number'&&index>=0){if(axis==='x'){for(i=0;i<spec.rows;i++){if(typeof matrix[i][index]!=='number'){method_split(matrix[i][index].origin);}}tbody.children('tr').each(function(){var td=$('td:eq('+index+')',this).filter('td[colspan][colspan!=1],td[rowspan][rowspan!=1]');if(td.length){method_split(td);}});tbody.children('tr').each(function(){$.removeData($('td:eq('+index+')',this).remove().get(0),TEDIT_NS);});spec.cols--;cg_fix();}else{var tr=tbody.children('tr:eq('+index+')'),i;tr.children('td[colspan][colspan!=1],td[rowspan][rowspan!=1]').each(function(){method_split(this);});for(i=0;i<spec.cols;i++){if(typeof matrix[index][i]!=='number'){method_split(matrix[index][i].origin);}}tr.remove().each(function(){$.removeData(this,TEDIT_NS);});tr=undefined;spec.rows--;rg_fix();}grid_size_fix();matrix_update();}return that;};var method_destroy=function(){ui.empty();for(var i in that){if(that.hasOwnProperty(i))that[i]=undefined;}return that=undefined;};var method_tbody=function(){var newTbody=$('<tbody></tbody>');tbody.children('tr').each(function(i){if(i<spec.thead){return true;}else if(i>=spec.rows-spec.tfoot){return false;}var tr=$('<tr></tr>');$(this).children('td').each(function(){var data=val($(this)),cellTag=data.tag==='th'?'th':'td',td=$('<'+cellTag+'></'+cellTag+'>');if(data.colspan){td.attr('colspan',data.colspan);}if(data.rowspan){td.attr('rowspan',data.rowspan);}tr.append(td.html(data.content));});newTbody.append(tr);});return newTbody;},method_thead=function(cellTag){var rows=spec.thead,thead=$('<thead></thead>');cellTag=cellTag==='th'?'th':'td';tbody.children('tr:lt('+rows+')').each(function(){var tr=$('<tr></tr>');$(this).children('td').each(function(){var th=$('<'+cellTag+'></'+cellTag+'>'),data=val($(this));if(data.colspan){th.attr('colspan',data.colspan);}if(data.rowspan){th.attr('rowspan',data.rowspan);}tr.append(th.html(data.content));});thead.append(tr);});return thead;},method_tfoot=function(cellTag){var rows=spec.tfoot,tfoot=$('<tfoot></tfoot>');cellTag=cellTag==='td'?'td':'th';tbody.children('tr:gt('+(spec.rows-rows-1)+')').each(function(){var tr=$('<tr></tr>');$(this).children('td').each(function(){var td=$('<'+cellTag+'></'+cellTag+'>'),data=val($(this));if(data.colspan){td.attr('colspan',data.colspan);}if(data.rowspan){td.attr('rowspan',data.rowspan);}tr.append(td.html(data.content));});tfoot.append(tr);});return tfoot;};var method_table=function(){var newTable=$('<table></table>');if(spec.thead){newTable.append(method_thead());}newTable.append(method_tbody());if(spec.tfoot){newTable.append(method_tfoot());}return newTable;};var method_spec=function(specName,specValue){var tds,i;if(arguments.length==1){return spec[specName]||undefined;}else if(arguments.length==2&&specName in spec){switch(specName){case'cols':if(typeof specValue==='number'&&spec.cols!==specValue){spec.cols=specValue;cg_fix();}break;case'rows':if(typeof specValue==='number'&&spec.rows!==specValue){spec.rows=specValue;rg_fix();}break;case'minCol':case'minRow':if(typeof specValue==='number'&&specValue>0){spec[specName]=specValue;}break;case'maxCol':case'maxRow':if(typeof specValue==='number'&&specValue>=0){spec[specName];}break;case'thead':case'tfoot':if(typeof specValue==='number'&&specValue>0){spec[specName]=specValue;selects_adj();}break;case'gridHeight':case'gridWidth':if(typeof specValue==='number'){spec[specName]=specValue;grid.css({height:spec.gridHeight,width:spec.gridWidth});}break;case'cellHeight':case'cellWidth':if(typeof specValue==='number'){spec[specName]=specValue;$('>tr>td',tbody).css({height:spec.cellHeight,width:spec.cellWidth});cg_ol.children().css('width',spec.cellWidth);rg_ol.children().css('height',spec.cellHeight);}break;case'dblclick':case'press':case'select':case'unselect':case'sort':if($.isFunction(specValue)){spec[specName]=specValue;}break;}}return that;};that.jquery=method_jquery;that.spec=method_spec;that.show=method_show;that.hide=method_hide;that.scroll=method_scroll;that.unselect=selection_cancel;that.val=method_val;that.insert=method_insert;that.del=method_delete;that.copy=method_copy;that.cut=method_cut;that.paste=method_paste;that.join=method_join;that.split=method_split;that.matrix=method_matrix;that.table=method_table;that.tbody=method_tbody;that.thead=method_thead;that.tfoot=method_tfoot;that.destroy=method_destroy;$.data(ui.get(0),TEDIT_NS,that);return that;};$.extend({tEdit:function(spec){return tedit(spec||{});}});$.fn.extend({tEdit:function(specOrMethod,methodArgs,methodArgs2){if(arguments.length===0||typeof specOrMethod==='object'){return tedit(specOrMethod||{},this).jquery();}else if(typeof specOrMethod==='string'){var teditObj=$.data(this.get(0),TEDIT_NS),methodName=specOrMethod.toLowerCase();switch(methodName){case'object':return teditObj;case'show':case'hide':case'insert':case'del':teditObj[methodName](methodArgs,methodArgs2);return this;case'unselect':case'destroy':teditObj[methodName]();return this;case'val':case'spec':if(methodArgs2){teditObj[methodName](methodArgs,methodArgs2);return this;}else{return teditObj[methodName](methodArgs);}case'copy':case'cut':case'paste':case'join':teditObj[methodName](methodArgs,methodArgs2);return this;case'scroll':case'split':teditObj[methodName](methodArgs);return this;case'matrix':if(methodArgs&&$.isArray(methodArgs)){teditObj[methodName](methodArgs);return this;}else{return teditObj[methodName](methodArgs);}case'thead':case'tfoot':if(methodArgs){teditObj[methodName](methodArgs);return this;}else{return teditObj[methodName]();}}}}})})(jQuery);